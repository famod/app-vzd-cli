= üóÇÔ∏è `vzd-cli`: Command Line Client f√ºr Verzeichnisdienst der TI 
:toc: auto

`vzd-cli` wurde in Vorbereitung der Migration des gematik Verzeichnisdienstes (VZD) von LDAP nach FHIR entwickelt. √úber ein modernes CLI (Command Line Interface) k√∂nnen neue und alte Schnittstellen des VZD genutzt werden.

== Installation

1. Download link:https://github.com/spilikin/app-vzd-cli/releases[Latest Release] von `vzd-cli` von github.
2. ``vzd-cli-<VERSION>.zip`` extrahieren 
3. Die Skripte in bin/ benutzen um `vzd-cli` zu starten

[source]
----
$ bin/vzd-cli --help
Usage: vzd-cli [OPTIONS] COMMAND [ARGS]...

Options:
  --env FILENAME  specify env file
  --version       Show the version and exit
  -h, --help      Show this message and exit

Commands:
  admin  CLI for DirectoryAdministration API
----

== Schnellstart

Aufbau der CLI folgt aktuellen Best-Practices analog z.B. zu Docker, Kubernetes, Helm.

.File namens `.env` im aktuellen Ordner anlegen:
[source,bash]
----
ADMIN_API_URL=https://vzdpflege-ref.vzd.ti-dienste.de:9543/
ADMIN_AUTH_URL=https://auth-ref.vzd.ti-dienste.de:9443/auth/realms/RSDirectoryAdministration/protocol/openid-connect/token
ADMIN_CLIENT_ID=<client id>
ADMIN_CLIENT_SECRET=<client secret>
#HTTP_PROXY_URL=http://192.168.110.10:3128/
----
.Beispiel: Suche nach einem Eintrag mit angegebenen telematikID
[source,bash]
----
bin/vzd-cli admin list --param telematikID=5-SMC-B-Testkarte-883110000092568
----

== `admin`: CLI f√ºr Directory Administration 

=== Configuration

|===
|Variable | Beschreibung 
|`ADMIN_API_URL`
| URL des Directory Administration API Endpoints 

|`ADMIN_AUTH_URL` +
`ADMIN_CLIENT_ID` +
`ADMIN_CLIENT_SECRET`
| Authentisierungsinformation 

|`ADMIN_ACCESS_TOKEN`
| Alternativ kann Access-Token als Umgebungsvariable gesetzt werden. Dadurch k√∂nnen mehrere Aufrufe des Clients ohne expliziten Authentisierung durchgef√ºhrt werden.

Benutzt <<cmd-admin-auth,admin auth>> um den Token zu besorgen.

|`HTTP_PROXY_URL`
| Optional: URL zum HTTP-Proxy, z.B.: `http://192.168.110.10:3128/`

|===

Die Umgebungsvariablen k√∂nnen in einer `.env` Datei gespeichert werden. Hier ist ein Beispiel f√ºr die Referenzumgebung:

[source,bash]
----
ADMIN_API_URL=https://vzdpflege-ref.vzd.ti-dienste.de:9543/
ADMIN_AUTH_URL=https://auth-ref.vzd.ti-dienste.de:9443/auth/realms/RSDirectoryAdministration/protocol/openid-connect/token
ADMIN_CLIENT_ID=<client id>
ADMIN_CLIENT_SECRET=<secret>
----

Standardm√§√üig wird die Datei mit Namen `.env` im aktuellen Arbeitsverzeichnis geladen. Alternativer Dateiname kann √ºber  `--env` Option angegeben werden:

[source,bash]
----
bin/vzd-cli --env ../.env.ru admin list
----

[#cmd-admin-info]
=== `admin info`

Zeigt die Information √ºber den VZD-Server und die API.

[source,bash]
----
bin/vzd-cli admin info
----


[#cmd-admin-auth]
=== `admin auth`

Authentisiert den Client und gibt `ACCESS_TOKEN` zur√ºck. Token kann danach in der Umgebungsvariable `ADMIN_ACCESS_TOKEN` gespeichert werden, damit weitere Client-Aufrufe keine erneute explizite Authentisierung durchf√ºhren m√ºssen.

.Beispiel: Authentisiert und speichert den ACCESS_TOKEN in die Umgebungsvariable 
[source,bash]
----
export ADMIN_ACCESS_TOKEN=`bin/vzd-cli admin auth`
----

[#cmd-admin-list]
=== `admin list`

==== Optionen
* `--param` oder `-p` +
Setzt einen Query-Parameter bei der Suche der Eintr√§ge √ºber die API. Kann mehrfach angegeben werden um die Parameter zu kombinieren. +
Die Liste von g√ºltigen Parametern kann aus https://github.com/gematik/api-vzd/blob/master/src/openapi/DirectoryAdministration.yaml[DirectoryAdministration API] entnommen werden (s. `read_Directory_Entry`)

* `--param-file` oder `-f` +
Liest Werte eines Parameters aus der Datei und fragt f√ºr jeden Wert nach Eintrag im VZD ab. Die Datei soll den gew√ºnschten Wert einmal pro Zeile enthalten:

.Beispiel: Findet alle Eintr√§ge mit TelematikID aus `telematik.txt`
[source,bash]
----
bin/vzd-cli admin --short list -f telematikID telematik.txt
----

.Inhalt von `telematik.txt`
----
4-SMC-B-Testkarte-883110000093329
3-SMC-B-Testkarte-883110000093294
2-SMC-B-Testkarte-883110000093645
3-SMCB-Testkarte-883110000092193
----


Suche und Anzeige von Verzeichnisdiensteintr√§gen.

[#cmd-admin-template]
=== `admin template`

Generiert die Dateivorlagen f√ºr `admin add` oder `admin modify` Befehle.

.Beispiel: Erzeugt eine Vorlage und schreibt es in eine YAML-Datei 
[source,bash]
----
bin/vzd-cli admin template base > Eintrag.yaml
----

.Beispiel: Erzeugt eine Vorlage und schreibt es in eine JSON-Datei 
[source,bash]
----
bin/vzd-cli admin --json template base > Eintrag.json
----

[#cmd-admin-add-base]
=== `admin add-base`

Neuen Verzeichnisdiensteintrag erstellen.

[#cmd-admin-load-base]
=== `admin load-base`

L√§dt einen Basiseintrag. Die geladene Struktur kann als Datei gespeichert werden, in einem Text-Editor bearbeitet und anschlie√üend mit `admin modify-base` modifiziert werden.

[#cmd-admin-modify-base]
=== `admin modify-base`

Modifiziert den gesamten Basiseintrag im Verzeichnisdienst.

[#cmd-admin-modify-base-attr]
=== `admin modify-base-attr`

Modifiziert einzelne Attribute des Basiseintrags

[#cmd-admin-delete]
=== `admin delete`

L√∂scht Eintr√§ge aus dem Verzeichnisdienst.

[#cmd-admin-list-cert]
=== `admin list-cert`

Suche und Anzeige von X509-Zertifikaten.

[#cmd-admin-add-cert]
=== `admin add-cert`

F√ºgt einen neuen X509-Zertifikat zu existierenden Verzeichnisdiensteintrag hinzu.

[source,bash]
----
# zuerst einen leeren Basiseintrag erzeugen
bin/vzd-cli admin add-base -s telematikID=1-123123
# danach Zertifikat hinzuf√ºgen
# Achtung: TelematikID beim Befehl admin add-base und im Zertifikat m√ºssen identisch sein
bin/vzd-cli admin add-cert 1-123123.der
----

[#cmd-admin-clear-cert]
=== `admin clear-cert`

L√∂scht alle Zertifikate aus dem angegeben Eintrag.

[source,bash]
----
bin/vzd-cli admin clear-cert -p telematikID=1-123123
----

[#cmd-admin-save-cert]
=== `admin save-cert`

Speichert alle gefundene Zertifikate in ein Verzeichnis

[#cmd-admin-delete-cert]
=== `admin delete-cert`

WARNING: Nicht implementiert

L√∂scht einen X509-Zertifikat.

